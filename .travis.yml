language: rust
sudo: false
cache: cargo

matrix:
  include:
    - os: osx
      osx_image: xcode9
      compiler: clang
      env:
        - JOB=metal
        - MACOSX_DEPLOYMENT_TARGET=10.9
    - os: linux
      compiler: gcc
      env:
        - JOB=vulkan
        - CXX=g++-5
      addons:
        apt:
          sources:
            - llvm-toolchain-precise
            - ubuntu-toolchain-r-test
          packages:
            - g++-5

before_script:
  - (test -x $HOME/.cargo/bin/cargo-install-update || cargo install cargo-update)
  - (test -x $HOME/.cargo/bin/mdbook || cargo install mdbook)
  - cargo install-update -a

script:
  - |
    if [[ $JOB == "metal" ]]; then \
      cargo build --features="metal" && \
      cargo build --features="metal" --release; \
    fi
  - |
    if [[ $JOB == "vulkan" ]]; then \
      cargo build --features="vulkan" && \
      cargo build --features="vulkan" --release && \
      cd book && mdbook build; \
    fi

deploy:
  provider: pages
  local-dir: target/book-output
  skip-cleanup: true
  github-token: $GITHUB_TOKEN
  keep-history: false
  name: DocsBot
  verbose: true
  on:
    branch: master
